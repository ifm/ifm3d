release:tag:
  stage: release
  image: python:3
  tags: [shared_docker]

  before_script:
  - |
    apt-get -y update
    apt-get -y install git
    git config --global user.email "support.robotics@ifm.com"
    git config --global user.name "ifm-csr"
  script:
    - python3 scripts/release/get_changelog_between_versions.py
    - git remote set-url origin https://"ifm-csr":$RELEASE_ACCESS_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git
    - export tag_value=$(cat VERSION | awk  '{print $1}' FS="*")
    - git tag -a $tag_value -F CHANGELOG
    - git push origin $tag_value
  artifacts:
    paths:
      - CHANGELOG
  rules:
    - if: ($CI_PIPELINE_SOURCE == "push") && ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH) && ($CI_COMMIT_MESSAGE =~ '/Release\/v\d+\.\d+\.\d+/')
      when: always
    - when: never

release:github:
  variables:
    GH_TOKEN: ${GITHUB_TOKEN}
  stage: release
  image: ghcr.io/cicirello/pyaction
  #needs:
  #  - job: build:linux:deb
  #    artifacts: true
  rules:
    - if: ($CI_PIPELINE_SOURCE == "push") && ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH) && ($CI_COMMIT_MESSAGE =~ '/Release\/v\d+\.\d+\.\d+/')
      when: always
    - when: never
  script:
    - python3 scripts/release/get_changelog_between_versions.py
    - echo $'\nThis is a pre-release and might contain bugs, we recommed to use last release version of ifm3d\n\n' | cat - CHANGELOG > CHANGELOG.tmp
    - export tag_value=$(cat VERSION | awk  '{print $1}' FS="*")
    - |
      while ! curl -sSfI https://github.com/inbangsa/ifm3d/releases/tag/$tag_value > /dev/null; do
       sleep 1
      done
    - gh --version
    - gh release create $tag_value -R https://github.com/inbangsa/ifm3d.git --prerelease -F CHANGELOG.tmp --title $tag_value --verify-tag
    - gh release upload $tag_value -R https://github.com/inbangsa/ifm3d.git ifm3d-*.tar

deploy:github:
  variables:
    GH_TOKEN: ${GITHUB_TOKEN}
  stage: predeploy
  image: ghcr.io/cicirello/pyaction
  
  
#  needs:
#    - job: release:github
#      artifacts: false
  
  rules:
    - !reference [.manual, rules]
  before_script:
  - |
    apt-get -y update
    apt-get -y install git
    git config --global user.email "support.robotics@ifm.com"
    git config --global user.name "ifm-csr"  
  script:
    - export tag_value=$(cat VERSION | awk  '{print $1}' FS="*")
    - gh release edit $tag_value  -R https://github.com/inbangsa/ifm3d.git --prerelease=false --latest